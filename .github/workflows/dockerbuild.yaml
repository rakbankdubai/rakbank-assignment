name: Build and publish a Docker image
on: workflow_dispatch  # You can trigger this workflow manually or on other events (push, pull_request)

jobs:
  build:
    name: Build & push Docker image
    runs-on: ubuntu-latest  # You can choose a different runner (e.g., ubuntu-18.04) if needed
    env:
      IMG_NAME: "aaryadaarya/rakbank"  # Replace "<image>" with your desired image name

    steps:
      - name: Checkout
        uses: actions/checkout@v3  # Downloads your code from the repository

      - name: Debug (Optional)
        run: |  # Optional step to see the current branch/tag reference
          echo "github.ref -> {{ github.ref }}"

      - name: Docker metadata
        id: metadata
        uses: docker/metadata-action@v3  # Generates metadata for your image tags
        with:
          images: ${{ env.IMG_NAME }}
          tags: |  # Defines different tag formats (version, major.minor, sha)
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value={{sha}},enable=${{ github.ref_type != 'tag' }}

      - name: Login to Docker Hub (using username/password from secret)
        # **Security Warning:** Using username/password for Docker Hub login is not recommended for production due to security risks.
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

      - name: Build and push Docker image
        uses: docker/build-push-action@v2  # Builds and pushes the image
        with:
          context: .  # Builds the image from the current directory
          push: true  # Pushes only for tags (not branches)
          tags: aaryadaarya/rakbank:v0  # Update with your desired image tag for GitHub Packages
          labels: ${{ steps.metadata.outputs.labels }}  # Uses labels generated by docker/metadata-action
